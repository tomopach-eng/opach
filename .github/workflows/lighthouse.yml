name: Lighthouse CI

on:
  # Uncomment the lines below after SSL is enabled and working
  # push:
  #   branches: [ main, master ]
  workflow_dispatch:

# Give the workflow permission to upload artifacts and perform Actions operations.
permissions:
  actions: write
  contents: read

jobs:
  lhci:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Wait for HTTPS and valid TLS
        run: |
          set -e
          url="opach.online"
          timeout=900
          interval=10
          elapsed=0

          echo "Waiting up to $timeout s for HTTPS and valid certificate at https://$url..."

          while [ $elapsed -lt $timeout ]; do
            http_code=$(curl -s -o /dev/null -w "%{http_code}" -I https://$url || true)
            cert_ok=$(echo | openssl s_client -servername $url -connect $url:443 2>/dev/null \
                      | openssl x509 -noout -checkend 60 >/dev/null 2>&1 && echo "1" || echo "0")

            if [ "$http_code" = "200" ] || [ "$http_code" = "301" ] || [ "$http_code" = "302" ]; then
              if [ "$cert_ok" = "1" ]; then
                echo "HTTPS + cert OK (http_code=$http_code)"
                exit 0
              fi
            fi

            echo "Not ready yet (http_code=$http_code, cert_ok=$cert_ok). Sleeping $interval s..."
            sleep $interval
            elapsed=$((elapsed + interval))
          done

          echo "Timed out waiting for HTTPS/certificate after $timeout seconds"
          exit 1

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Run Lighthouse on live site (do not upload artifacts internally)
        uses: treosh/lighthouse-ci-action@v10
        with:
          urls: |
            https://opach.online
          uploadArtifacts: false            # <-- important: disable internal artifact creation
          temporaryPublicStorage: false     # optional: avoid other upload mechanisms that may fail
          configPath: ""
          runs: 1

      # Prepare artifact only if report dir exists (and only for trusted runs, not fork PRs)
      - name: Check for lighthouse report
        id: check_report
        run: |
          REPORT_DIR="./lighthouse-report"
          if [ -d "$REPORT_DIR" ]; then
            echo "report_exists=true" >> "$GITHUB_OUTPUT"
            # create a tarball to make upload robust
            TAR="/tmp/lh_report_${GITHUB_RUN_ID}.tar.gz"
            tar -czf "$TAR" -C "$REPORT_DIR" .
            echo "tar_path=$TAR" >> "$GITHUB_OUTPUT"
          else
            echo "report_exists=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Upload Lighthouse results artifact
        if: ${{ steps.check_report.outputs.report_exists == 'true' && ((github.event_name != 'pull_request') || (github.event.pull_request.head.repo.full_name == github.repository)) }}
        uses: actions/upload-artifact@v4
        with:
          name: lighthouse-results-${{ github.run_id }}
          path: ${{ steps.check_report.outputs.tar_path }}

      - name: (Optional) Show link to uploaded artifact
        if: ${{ steps.check_report.outputs.report_exists == 'true' && ((github.event_name != 'pull_request') || (github.event.pull_request.head.repo.full_name == github.repository)) }}
        run: |
          echo "Uploaded artifact name: lighthouse-results-${GITHUB_RUN_ID}"
          echo "If you need the raw report directory, download the artifact from the Actions run UI."